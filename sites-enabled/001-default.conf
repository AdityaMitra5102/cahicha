<VirtualHost *:80>
    ServerName $$domainname$$
    DocumentRoot /var/www/auth

    # Enable required modules
    LoadModule rewrite_module modules/mod_rewrite.so
    LoadModule proxy_module modules/mod_proxy.so
    LoadModule proxy_http_module modules/mod_proxy_http.so
    LoadModule wsgi_module modules/mod_wsgi.so
    
    # Define RewriteMap at VirtualHost level
    RewriteMap validate_cookie prg:/var/www/auth/scripts/validate_cookie.py
    
    # Enable rewrite engine
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/cahichacheck
    # If valid token exists, proxy to port 8080
    RewriteCond %{HTTP_COOKIE} cahicha_token=([^;]+)
    RewriteCond ${validate_cookie:%1} ^valid$
    RewriteRule ^(.*)$ http://$$host$$:$$port$$$1 [P,L]
    
    # Default: proxy to port 5000 for everything else
    ProxyPass / http://localhost:5000/
    ProxyPassReverse / http://localhost:5000/
    
</VirtualHost>

