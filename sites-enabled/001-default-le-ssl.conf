<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName cahicha.mukham.in
    DocumentRoot /var/www/auth
    
    # Enable required modules
    LoadModule rewrite_module modules/mod_rewrite.so
    LoadModule proxy_module modules/mod_proxy.so
    LoadModule proxy_http_module modules/mod_proxy_http.so
    LoadModule wsgi_module modules/mod_wsgi.so
    
    # Define RewriteMap at VirtualHost level
    RewriteMap validate_cookie prg:/var/www/auth/scripts/validate_cookie.py
    
    # Enable rewrite engine
    RewriteEngine On
    
    # If valid token exists, proxy to port 8080
    RewriteCond %{HTTP_COOKIE} cahicha_token=([^;]+)
    RewriteCond ${validate_cookie:%1} ^valid$
    RewriteRule ^(.*)$ http://localhost:8080$1 [P,L]
    
    # Default: proxy to port 5000 for everything else
    ProxyPass / http://localhost:5000/
    ProxyPassReverse / http://localhost:5000/
    

SSLCertificateFile /etc/letsencrypt/live/cahicha.mukham.in/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/cahicha.mukham.in/privkey.pem
Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>
</IfModule>
